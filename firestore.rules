rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users — only the user themselves or platform admin
    match /users/{uid} {
      allow read: if request.auth != null && (request.auth.uid == uid || request.auth.token.role == 'PLATFORM_ADMIN');
      allow write: if request.auth != null && (request.auth.uid == uid || request.auth.token.role == 'PLATFORM_ADMIN');
    }

    // Properties — admin of the property or platform admin
    match /properties/{propId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (resource.data.admin_uid == request.auth.uid || request.auth.token.role == 'PLATFORM_ADMIN');

      match /rooms/{roomId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // Tours — operator or platform admin
    match /tours/{tourId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (resource.data.operator_uid == request.auth.uid || request.auth.token.role == 'PLATFORM_ADMIN');

      match /time_slots/{slotId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
      }
    }

    // Itineraries — owner or platform admin
    match /itineraries/{itinId} {
      allow read: if request.auth != null && (resource.data.traveler_uid == request.auth.uid || request.auth.token.role == 'PLATFORM_ADMIN');
      allow write: if request.auth != null && (request.auth.uid == resource.data.traveler_uid || request.auth.token.role == 'PLATFORM_ADMIN');
      allow create: if request.auth != null;

      match /bookings/{bookingId} {
        allow read, write: if request.auth != null;
      }
      match /activities/{actId} {
        allow read, write: if request.auth != null;
      }
    }

    // Disruption events — any authenticated user can read; write via backend only
    match /disruption_events/{eventId} {
      allow read: if request.auth != null;
      allow write: if false; // backend only
    }

    // Activity log — read for admins; write via backend only
    match /activity_log/{logId} {
      allow read: if request.auth != null && (request.auth.token.role == 'PLATFORM_ADMIN' || request.auth.token.role == 'HOTEL_ADMIN' || request.auth.token.role == 'TOUR_OPERATOR');
      allow write: if false; // backend only
    }

    // Alerts — target user or platform admin can read; write via backend only
    match /alerts/{alertId} {
      allow read: if request.auth != null && (resource.data.target_uid == request.auth.uid || request.auth.token.role == 'PLATFORM_ADMIN');
      allow update: if request.auth != null && resource.data.target_uid == request.auth.uid;
      allow create, delete: if false; // backend only
    }
  }
}
